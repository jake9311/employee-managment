
<mat-card>
  <mat-card-title>ייצוא דוחות</mat-card-title>

  <form>
    <mat-form-field>
      <mat-label>שם העובד</mat-label>
      <input
        type="text"
        matInput
        placeholder="הקלד את שם העובד"
        [(ngModel)]="selectedGuardName"
        [matAutocomplete]="auto"
        (input)="filterGuards()"
        name="guardName"
      />

      <mat-autocomplete #auto="matAutocomplete" (optionSelected)="onGuardSelected($event.option.value)">
        <mat-option [value]="''">כל העובדים</mat-option>
        <mat-option *ngFor="let guard of filteredGuards" [value]="guard.name">
          {{ guard.name }}
        </mat-option>
      </mat-autocomplete>
    </mat-form-field>

    <mat-form-field>
      <mat-label>מתאריך</mat-label>
      <input matInput [matDatepicker]="startPicker" [(ngModel)]="startDate" name="startDate" />
      <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
      <mat-datepicker #startPicker></mat-datepicker>
    </mat-form-field>

    <mat-form-field>
      <mat-label>עד תאריך</mat-label>
      <input matInput [matDatepicker]="endPicker" [(ngModel)]="endDate" name="endDate" />
      <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
      <mat-datepicker #endPicker></mat-datepicker>
    </mat-form-field>

    <mat-form-field>
      <mat-label>סוג דיווח</mat-label>
      <mat-select [(ngModel)]="selectedType" name="type">
        <mat-option [value]="''">כל הדיווחים</mat-option>
        <mat-option *ngFor="let type of types" [value]="type">
          {{ type }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <button mat-raised-button color="primary" type="button" (click)="exportToExcel()">ייצא דיווחים</button>
    <button mat-raised-button color="accent" type="button" (click)="applyFilters()">
      <mat-icon>filter_list</mat-icon>סנן תוצאות
    </button>
  </form>
</mat-card>

<div class="table-wrap" *ngIf="filteredReports.length > 0">
  <table mat-table [dataSource]="dataSource" matSort class="mat-elevation-z1 reports-table">


    <ng-container matColumnDef="guardName">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>שם מאבטח</th>
      <td mat-cell *matCellDef="let r">{{ r.guardName }}</td>
    </ng-container>


    <ng-container matColumnDef="type">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>סוג דיווח</th>
      <td mat-cell *matCellDef="let r">{{ r.type }}</td>
    </ng-container>


    <ng-container matColumnDef="date">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>תאריך</th>
      <td mat-cell *matCellDef="let r">
        {{ getDisplayDate(r) ? (getDisplayDate(r) | date:'dd/MM/yyyy') : '-' }}
      </td>
    </ng-container>


    <ng-container matColumnDef="scheduledHour">
      <th mat-header-cell *matHeaderCellDef>שעת מקור</th>
      <td mat-cell *matCellDef="let r">{{ r.scheduledHour || '-' }}</td>
    </ng-container>


    <ng-container matColumnDef="actualHour">
      <th mat-header-cell *matHeaderCellDef>שעת הגעה</th>
      <td mat-cell *matCellDef="let r">{{ r.actualHour || '-' }}</td>
    </ng-container>


    <ng-container matColumnDef="startDate">
      <th mat-header-cell *matHeaderCellDef>תאריך התחלה</th>
      <td mat-cell *matCellDef="let r">{{ r.startDate ? (r.startDate | date:'dd/MM/yyyy') : '-' }}</td>
    </ng-container>

  
    <ng-container matColumnDef="endDate">
      <th mat-header-cell *matHeaderCellDef>תאריך סיום</th>
      <td mat-cell *matCellDef="let r">{{ r.endDate ? (r.endDate | date:'dd/MM/yyyy') : '-' }}</td>
    </ng-container>

  
    <ng-container matColumnDef="hasApproval">
      <th mat-header-cell *matHeaderCellDef>אישור מחלה</th>
      <td mat-cell *matCellDef="let r">
        {{ r.type === 'מחלה' ? (r.hasApproval ? 'הובא' : 'לא הובא') : '-' }}
      </td>
    </ng-container>

 
    <ng-container matColumnDef="reason">
      <th mat-header-cell *matHeaderCellDef>סיבה</th>
      <td mat-cell *matCellDef="let r" class="reason-cell">
        {{ r.reason || '-' }}
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
  </table>
</div>

<div *ngIf="filteredReports.length === 0">
  <p>אין דוחות להצגה.</p>
</div>
